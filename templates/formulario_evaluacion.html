{% extends 'base.html' %}
{% block title %}NutriApp - Formulario de Evaluación{% endblock %}

{% block content %}
<div class="container mt-3 mb-5">

   <!-- CABECERA DEL FORMULARIO -->
   <div class="row mb-4 align-items-center">
    <div class="col-md-12">
      <h2><i class="fas fa-notes-medical"></i> Formulario de Evaluación Nutricional</h2>
      <p class="text-muted">
        Fecha: <span id="consultation_date">{{ current_date_str }}</span> |
        Usuario: <span id="username">{{ current_username }}</span>
      </p>
      <p id="loaded_evaluation_id_display" class="text-info fw-bold"></p>
    </div>
  </div>

  <form id="patient-plan-form">
    <input type="hidden" id="patient_id" name="patient_id">
    <input type="hidden" id="loaded_evaluation_id" name="loaded_evaluation_id">
    <input type="hidden" id="form_action" name="form_action" value="{{ action | default('new_evaluation_new_patient') }}">
 
    <!-- I. Identificación y Datos Filiatorios -->
    <div class="card shadow-sm mb-4">
      <div class="card-header bg-light">
        <h3 class="mb-0"><i class="fas fa-id-card"></i> Identificación y Datos Filiatorios</h3>
      </div>
      <div class="card-body">
        <fieldset>
          <div class="row g-3 mb-3">
            <div class="col-md-6">
              <label for="name" class="form-label">Nombre<span class="text-danger">*</span>:</label>
              <input type="text" id="name" name="name" class="form-control form-control-sm" required>
            </div>
            <div class="col-md-6">
              <label for="surname" class="form-label">Apellido<span class="text-danger">*</span>:</label>
              <input type="text" id="surname" name="surname" class="form-control form-control-sm" required>
            </div>
            <div class="col-md-4">
              <label for="cedula" class="form-label">Cédula<span class="text-danger">*</span>:</label>
              <input type="text" id="cedula" name="cedula" class="form-control form-control-sm" required>
            </div>
            <div class="col-md-4">
              <label for="dob" class="form-label">Fecha Nacimiento<span class="text-danger">*</span>:</label>
              <input type="date" id="dob" name="dob" class="form-control form-control-sm" required>
            </div>
            <div class="col-md-4">
              <label for="sex" class="form-label">Sexo<span class="text-danger">*</span>:</label>
              <select id="sex" name="sex" class="form-select form-select-sm" required>
                <option value="">Seleccionar...</option>
                <option value="femenino">Femenino</option>
                <option value="masculino">Masculino</option>
              </select>
            </div>
            <div class="col-md-6">
              <label for="email" class="form-label">Email Paciente:</label>
              <input type="email" id="email" name="email" class="form-control form-control-sm" placeholder="ejemplo@dominio.com">
            </div>
            <div class="col-md-6">
              <label for="phone_number" class="form-label">Teléfono Móvil:</label>
              <input type="tel" id="phone_number" name="phone_number" class="form-control form-control-sm" placeholder="+codigo pais + numero">
            </div>
            <div class="col-md-6">
              <label for="education_level" class="form-label">Nivel Educativo:</label>
              <select id="education_level" name="education_level" class="form-select form-select-sm">
                <option value="" selected>No especificado</option>
                {% for val, desc in education_levels %}
                  <option value="{{ val }}">{{ desc }}</option>
                {% endfor %}
              </select>
            </div>
            <div class="col-md-6">
              <label for="purchasing_power" class="form-label">Poder Adquisitivo:</label>
              <select id="purchasing_power" name="purchasing_power" class="form-select form-select-sm">
                <option value="" selected>No especificado</option>
                {% for val, desc in purchasing_power_levels %}
                  <option value="{{ val }}">{{ desc }}</option>
                {% endfor %}
              </select>
            </div>
          </div>
        </fieldset>
      </div>
    </div>

    <!-- Contenedor para mensajes de error de validación del formulario -->
    <div id="validation-error-container" style="display: none; margin-bottom: 1rem;"></div>

    <!-- II. Antropometría y Nivel de Actividad -->
    <div class="card shadow-sm mb-4">
      <div class="card-header bg-primary text-white">
        <h3 class="mb-0"><i class="fas fa-ruler-combined"></i> Antropometría y Nivel de Actividad</h3>
      </div>
      <div class="card-body">
        <fieldset>
          <div class="row g-3 mb-3">
            <div class="col-md-4">
              <label for="height_cm" class="form-label">Altura (cm)<span class="text-danger">*</span>:</label>
              <input type="number" step="0.1" id="height_cm" name="height_cm" class="form-control form-control-sm" required min="30" max="300">
            </div>
            <div class="col-md-4">
              <label for="weight_at_plan" class="form-label">Peso Actual (kg)<span class="text-danger">*</span>:</label>
              <input type="number" step="0.1" id="weight_at_plan" name="weight_at_plan" class="form-control form-control-sm" required min="1" max="500">
            </div>
            <div class="col-md-4">
              <label for="wrist_circumference_cm" class="form-label">P. Muñeca (cm):</label>
              <input type="number" step="0.1" id="wrist_circumference_cm" name="wrist_circumference_cm" class="form-control form-control-sm" min="5" max="40">
            </div>
            <div class="col-md-4">
              <label for="waist_circumference_cm" class="form-label">P. Cintura (cm):</label>
              <input type="number" step="0.1" id="waist_circumference_cm" name="waist_circumference_cm" class="form-control form-control-sm" min="30" max="300">
            </div>
            <div class="col-md-4">
              <label for="hip_circumference_cm" class="form-label">P. Cadera (cm):</label>
              <input type="number" step="0.1" id="hip_circumference_cm" name="hip_circumference_cm" class="form-control form-control-sm" min="30" max="300">
            </div>
            <div class="col-md-4">
              <label for="gestational_age_weeks" class="form-label">Edad Gestacional (sem):</label>
              <input type="number" step="1" min="0" id="gestational_age_weeks" name="gestational_age_weeks" class="form-control form-control-sm" value="0" max="45">
            </div>
            <div class="col-md-12">
              <label for="activity_factor" class="form-label">Nivel de Actividad<span class="text-danger">*</span>:</label>
              <select id="activity_factor" name="activity_factor" class="form-select form-select-sm" required>
                {% for factor, desc in activity_factors %}
                  <option value="{{ factor }}">{{ desc }}</option>
                {% endfor %}
              </select>
            </div>
          </div>
          <div class="row g-3 border-top pt-3 text-center">
            <div class="col-md-4"><p class="mb-1"><strong>GET (kcal):</strong></p><span id="calculated-get">--</span></div>
            <div class="col-md-4"><p class="mb-1"><strong>Complexión:</strong></p><span id="calculated-complexion">--</span></div>
            <div class="col-md-4"><p class="mb-1"><strong>Peso Ideal (Est.):</strong></p><span id="calculated-ideal-weight">-- kg</span></div>
          </div>
          <div class="row g-3 border-top pt-3 text-center">
            <div class="col-md-4"><p class="mb-1"><strong>IMC:</strong></p><span id="calculated-imc">--</span><div id="imc-ranges" class="reference-text text-start"></div></div>
            <div class="col-md-4"><p class="mb-1"><strong>Índice Cintura/Cadera:</strong></p><span id="calculated-whr">--</span><div id="whr-ranges" class="reference-text text-start"></div></div>
            <div class="col-md-4"><p class="mb-1"><strong>Índice Cintura/Altura:</strong></p><span id="calculated-whtr">--</span><div id="whtr-ranges" class="reference-text text-start"></div></div>
          </div>
        </fieldset>
      </div>
    </div>

    <!-- III. Condiciones Clínicas -->
    <div class="card shadow-sm mb-4">
      <div class="card-header bg-light"><h3 class="mb-0"><i class="fas fa-heartbeat"></i> Condiciones Clínicas</h3></div>
      <div class="card-body">
        <fieldset>
          <div class="row">
            <div class="col-md-6">
              <label class="form-label">Patologías:</label>
              <div class="checkbox-group mb-3">
                {% for patho in available_pathologies %}<div class="form-check form-check-inline"><input class="form-check-input" type="checkbox" id="patho_{{ loop.index }}" name="pathologies" value="{{ patho }}"><label class="form-check-label" for="patho_{{ loop.index }}">{{ patho }}</label></div>{% endfor %}
              </div>
            </div>
            <div class="col-md-6">
              <div class="mb-2"><label for="other_pathologies_text" class="form-label">Otras Patologías:</label><input type="text" id="other_pathologies_text" name="other_pathologies_text" class="form-control form-control-sm"></div>
              <div class="mb-2"><label for="postoperative_text" class="form-label">Postoperatorio:</label><input type="text" id="postoperative_text" name="postoperative_text" class="form-control form-control-sm"></div>
            </div>
          </div>
        </fieldset>
      </div>
    </div>

    <!-- IV. Alergias / Preferencias / Aversiones -->
    <div class="card shadow-sm mb-4">
      <div class="card-header bg-light"><h3 class="mb-0"><i class="fas fa-utensils"></i> Alergias, Preferencias y Aversiones</h3></div>
      <div class="card-body">
        <fieldset>
          <div class="row g-3">
            <div class="col-md-6"><label for="allergies" class="form-label">Alergias (Enter o coma):</label><input type="text" id="allergies" name="allergies" class="form-control form-control-sm"></div>
            <div class="col-md-6"><label for="intolerances" class="form-label">Intolerancias (Enter o coma):</label><input type="text" id="intolerances" name="intolerances" class="form-control form-control-sm"></div>
            <div class="col-md-6"><label for="preferences" class="form-label">Preferencias (Enter o coma):</label><input type="text" id="preferences" name="preferences" class="form-control form-control-sm"></div>
            <div class="col-md-6"><label for="aversions" class="form-label">Aversiones (Enter o coma):</label><input type="text" id="aversions" name="aversions" class="form-control form-control-sm"></div>
          </div>
        </fieldset>
      </div>
    </div>

    <!-- V. Dieta y Objetivos -->
    <div class="card shadow-sm mb-4">
      <div class="card-header bg-light"><h3 class="mb-0"><i class="fas fa-balance-scale"></i> Tipo de Dieta y Objetivos</h3></div>
      <div class="card-body">
        <fieldset>
          <div class="row g-3">
            <div class="col-md-6">
              <label for="diet_type" class="form-label">Tipo de Dieta Base:</label>
              <select id="diet_type" name="diet_type" class="form-select form-select-sm"><option value="" selected>Seleccionar...</option>{% for val, desc in diet_types %}<option value="{{ val }}">{{ desc }}</option>{% endfor %}</select>
              <label for="other_diet_type_text" class="form-label mt-2">Especificar "Otra Dieta":</label><input type="text" id="other_diet_type_text" name="other_diet_type_text" class="form-control form-control-sm" placeholder="Si 'Otra'">
            </div>
            <div class="col-md-6">
              <div class="row">
                <div class="col-sm-6"><label for="target_weight" class="form-label">Peso Objetivo (kg)<span class="text-danger">*</span>:</label><input type="number" step="0.1" id="target_weight" name="target_weight" class="form-control form-control-sm" required min="1" max="500"></div>
                <div class="col-sm-6"><label for="target_waist_cm" class="form-label">Cintura Objetivo (cm):</label><input type="number" step="0.1" id="target_waist_cm" name="target_waist_cm" class="form-control form-control-sm" min="30" max="300"></div>
              </div>
              <label class="form-label mt-2">Macros Objetivo (%):</label>
              <div class="input-group input-group-sm">
                <span class="input-group-text">P:</span><input type="number" step="0.1" min="0" max="100" id="target_protein_perc" name="target_protein_perc" class="form-control" placeholder="20">
                <span class="input-group-text">C:</span><input type="number" step="0.1" min="0" max="100" id="target_carb_perc" name="target_carb_perc" class="form-control" placeholder="50">
                <span class="input-group-text">G:</span><input type="number" step="0.1" min="0" max="100" id="target_fat_perc" name="target_fat_perc" class="form-control" placeholder="30">
              </div>
              <div class="form-text">Suma aprox. 100%.</div>
            </div>
          </div>
        </fieldset>
      </div>
    </div>
 
    <!-- Nueva Sección: Incluir Preparaciones Favoritas -->
    <div class="card shadow-sm mb-4">
      <div class="card-header bg-info text-white">
        <h3 class="mb-0"><i class="fas fa-star"></i> Incluir Preparaciones Favoritas</h3>
      </div>
      <div class="card-body">
        <p class="text-muted">
          Aquí se listarán tus preparaciones favoritas que podrían ser adecuadas para este paciente.
          Selecciona las que deseas intentar incluir en el plan generado por la IA.
        </p>
        <button type="button" class="btn btn-sm btn-outline-info mb-3" id="btn-load-relevant-preparations">
          <i class="fas fa-sync-alt"></i> Cargar/Actualizar Preparaciones Relevantes
        </button>
        <div id="relevant-preparations-container">
          <!-- Las preparaciones relevantes se cargarán aquí con JavaScript -->
          <p id="relevant-preparations-placeholder">Haz clic en el botón para buscar preparaciones.</p>
        </div>
      </div>
    </div>

    <!-- VI. Micronutrientes y Alimentos Base -->
    <div class="card shadow-sm mb-4">
      <div class="card-header bg-light"><h3 class="mb-0"><i class="fas fa-flask"></i> Micronutrientes y Alimentos Base</h3></div>
      <div class="card-body">
        <fieldset>
          <div class="row g-3">
            <div class="col-md-3"><label for="mic_k" class="form-label">Potasio (mg):</label><input type="number" step="1" min="0" max="10000" id="mic_k" name="mic_k" class="form-control form-control-sm" placeholder="3500"></div>
            <div class="col-md-3"><label for="mic_ca" class="form-label">Calcio (mg):</label><input type="number" step="1" min="0" max="5000" id="mic_ca" name="mic_ca" class="form-control form-control-sm" placeholder="1000"></div>
            <div class="col-md-3"><label for="mic_na" class="form-label">Sodio (mg):</label><input type="number" step="1" min="0" max="5000" id="mic_na" name="mic_na" class="form-control form-control-sm" placeholder="1500"></div>
            <div class="col-md-3"><label for="mic_chol" class="form-label">Colesterol (mg):</label><input type="number" step="1" min="0" max="1000" id="mic_chol" name="mic_chol" class="form-control form-control-sm" placeholder="300"></div>
          </div>
          <hr class="my-3">
          <div class="mb-3"><label for="base_foods" class="form-label">Alimentos Base (Enter o coma):</label><input type="text" id="base_foods" name="base_foods" class="form-control form-control-sm" placeholder="arroz, pollo"></div>
        </fieldset>
      </div>
    </div>
 
    <div class="text-center my-4"><button type="button" class="btn btn-primary btn-lg" id="btn-generar-plan"><i class="fas fa-cogs"></i> Generar Plan con IA</button></div>
  </form>

  <div id="plan-display-section" class="card mt-4 shadow-sm" style="display:none;">
    <div class="card-header bg-light"><h3 class="mb-0"><i class="fas fa-file-alt"></i> Plan Generado (Revisar y Editar)</h3></div>
    <div class="card-body">
      <div class="mb-3">
        <label for="planTextArea" class="form-label">Contenido del Plan (Editable):</label>
        <textarea id="planTextArea" name="planTextArea" rows="15" class="form-control"></textarea>
      </div>
      <!-- Nuevo DIV para mostrar el plan con botones de favorito -->
      <div class="mb-3">
        <label class="form-label">Vista del Plan con Opciones:</label>
        <div id="plan-display-con-favoritos" class="p-3 border rounded bg-light" style="white-space: pre-wrap; font-family: monospace; min-height: 200px;">
            <!-- El contenido se generará con JavaScript -->
        </div>
      </div>
      <div class="mb-3"><label for="user_observations" class="form-label">Observaciones Adicionales (PDF):</label><textarea id="user_observations" name="user_observations" rows="5" class="form-control"></textarea></div>
      <div class="d-grid gap-2 d-md-flex justify-content-md-center">
        <button type="button" class="btn btn-success btn-lg me-md-2" onclick="finalizar()"><i class="fas fa-save"></i> Guardar NUEVA Evaluación y Archivos</button>
        <button type="button" id="viewTechnicalPdfButton" class="btn btn-info btn-lg" style="display: none;" onclick="verPdfTecnico()"><i class="fas fa-file-medical-alt"></i> Ver Ficha Técnica (PDF)</button>
        <button type="button" id="viewPatientPdfButton" class="btn btn-light btn-lg border" style="display: none;" onclick="verPdfPaciente()"><i class="fas fa-user-graduate"></i> Ver Plan para Paciente (PDF)</button>
        <button type="button" id="sendEmailToPatientButton" class="btn btn-warning btn-lg" style="display: none;"><i class="fas fa-envelope"></i> Enviar Plan por Email</button>
      </div>
      <div id="final-message" class="mt-3 alert" style="display: none;"></div>
    </div>
  </div>
</div>
{% endblock %}

{% block scripts %}
{{ super() }}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        console.log("Formulario de Evaluación: DOMContentLoaded disparado."); 
        
        const serverContextAction = {{ action | default(None) | tojson | safe }};
        let serverContextEvaluationData = {{ evaluation_data_to_load | tojson | safe }}; // Should be null if not 'edit_evaluation'
        
        console.log("Initial serverContextAction:", serverContextAction);
        console.log("Initial serverContextEvaluationData (from Jinja):", JSON.stringify(serverContextEvaluationData));

        const urlParams = new URLSearchParams(window.location.search);
        const actionFromUrl = urlParams.get('action');
        const patientIdToLoadFromUrl = urlParams.get('patient_id');
        const evaluationIdToLoadFromUrl = urlParams.get('load_evaluation_id');
        
        let currentAction = actionFromUrl || serverContextAction || 'new_evaluation_new_patient';
        let isEditMode = false;

        const loadedEvaluationIdDisplay = document.getElementById('loaded_evaluation_id_display');
        const saveButton = document.querySelector('button[onclick="finalizar()"]');
        const formActionInput = document.getElementById('form_action');
        const planTextArea = document.getElementById('planTextArea'); 
        const planDisplayConFavoritosDiv = document.getElementById('plan-display-con-favoritos');
        const btnGenerarPlan = document.getElementById('btn-generar-plan');
        const sendEmailButton = document.getElementById('sendEmailToPatientButton');
        const viewPatientPdfBtn = document.getElementById('viewPatientPdfButton');
        
        let currentFullPlanText = "";
        const tagifyFieldNames = ['allergies', 'intolerances', 'preferences', 'aversions', 'base_foods'];

        console.log("Formulario de Evaluación: Tagify initialization is expected from main.js (window.tagifyInstances).");

        function clearPreloadForm(clearPatientData = true) {
            console.log("Formulario de Evaluación: clearPreloadForm. Clear patient data:", clearPatientData);
            const evaluationFieldsIds = [
                'weight_at_plan', 'wrist_circumference_cm', 'waist_circumference_cm', 'hip_circumference_cm',
                'gestational_age_weeks', 'activity_factor', 'other_pathologies_text', 'postoperative_text',
                'diet_type', 'other_diet_type_text', 'target_weight', 'target_waist_cm',
                'target_protein_perc', 'target_carb_perc', 'target_fat_perc',
                'planTextArea', 'user_observations',
                'mic_k', 'mic_ca', 'mic_na', 'mic_chol'
            ];
            evaluationFieldsIds.forEach(id => {
                const field = document.getElementById(id);
                if (field) { field.type === 'checkbox' || field.type === 'radio' ? field.checked = false : field.value = ''; }
            });
            document.querySelectorAll('input[name="pathologies"]').forEach(chk => { chk.checked = false; });
            
            tagifyFieldNames.forEach(fieldName => {
                if (window.tagifyInstances && window.tagifyInstances[fieldName] && typeof window.tagifyInstances[fieldName].removeAllTags === 'function') {
                    window.tagifyInstances[fieldName].removeAllTags();
                }
            });

            if (clearPatientData) {
                const patientFieldsIds = [
                    'patient_id', 'name', 'surname', 'cedula', 'email', 'phone_number',
                    'education_level', 'purchasing_power', 'dob', 'sex', 'height_cm'
                ];
                patientFieldsIds.forEach(id => {
                    const field = document.getElementById(id);
                    if (field) { field.type === 'checkbox' || field.type === 'radio' ? field.checked = false : field.value = ''; }
                });
            }
            const calculatedFields = ['calculated-get', 'calculated-complexion', 'calculated-ideal-weight', 'calculated-imc', 'calculated-whr', 'calculated-whtr'];
            calculatedFields.forEach(id => { const el = document.getElementById(id); if(el) { el.textContent = id.includes('weight') ? '-- kg' : '--'; } });
            const rangeFields = ['imc-ranges', 'whr-ranges', 'whtr-ranges'];
            rangeFields.forEach(id => { const el = document.getElementById(id); if(el) { el.innerHTML = ''; } });
            
            if (planTextArea) { planTextArea.value = ''; }
            if (document.getElementById('user_observations')) { document.getElementById('user_observations').value = ''; }
            if (planDisplayConFavoritosDiv) { planDisplayConFavoritosDiv.innerHTML = "<p>El plan aparecerá aquí con opciones.</p>"; }
            currentFullPlanText = "";
            if (typeof currentPlanDataBaseData !== 'undefined') { currentPlanDataBaseData = null; }
            
            const hiddenFields = ['loaded_evaluation_id'];
            hiddenFields.forEach(id => { const el = document.getElementById(id); if(el) { el.value = ''; } });
            if(loadedEvaluationIdDisplay) { loadedEvaluationIdDisplay.textContent = ''; }
            if(document.getElementById('plan-display-section')) { document.getElementById('plan-display-section').style.display = 'none'; }
        }

        function populateTagifyFieldWhenReady(fieldName, dataArray) {
            if (!Array.isArray(dataArray)) {
                console.warn(`populateTagifyFieldWhenReady: dataArray for ${fieldName} is not an array. Received:`, dataArray);
                dataArray = []; 
            }
            
            const stringDataArray = dataArray.map(item => String(item || '').trim()).filter(item => item);

            if (window.tagifyInstances && window.tagifyInstances[fieldName]) {
                const tagifyInstance = window.tagifyInstances[fieldName];
                tagifyInstance.removeAllTags();
                if (stringDataArray.length > 0) {
                    tagifyInstance.addTags(stringDataArray);
                }
                console.log(`Populate (direct): Tagify field '${fieldName}' updated with tags:`, JSON.stringify(stringDataArray));
            } else {
                const inputElement = document.getElementById(fieldName);
                if (inputElement) {
                    inputElement.value = stringDataArray.join(',');
                    console.warn(`Populate (fallback): Tagify instance for '${fieldName}' not ready. Set input.value to:`, inputElement.value);
                }
                setTimeout(() => {
                    if (window.tagifyInstances && window.tagifyInstances[fieldName]) {
                        const tagifyInstanceRetry = window.tagifyInstances[fieldName];
                        tagifyInstanceRetry.removeAllTags();
                         if (stringDataArray.length > 0) {
                            tagifyInstanceRetry.addTags(stringDataArray);
                        }
                        console.log(`Populate (retry): Tagify field '${fieldName}' updated with tags:`, JSON.stringify(stringDataArray));
                    } else {
                        console.error(`Populate (retry failed): Tagify instance for '${fieldName}' still not available.`);
                    }
                }, 1000); 
            }
        }

        function populatePreloadForm(data, isFullEvaluationLoad) {
            console.log("Formulario de Evaluación: populatePreloadForm. Full load:", isFullEvaluationLoad, "Data:", JSON.stringify(data, null, 2));
            if (!data || typeof data !== 'object') {
                console.error("populatePreloadForm: No data provided or data is not an object.");
                return;
            }

            function setValue(id, value, isDate = false) {
                const el = document.getElementById(id);
                if (el) {
                    let finalValue = value !== null && value !== undefined ? String(value) : '';
                    if (isDate && finalValue) {
                        if (finalValue.includes('T')) {
                            finalValue = finalValue.split('T')[0];
                        }
                    }
                    el.value = finalValue;
                }
            }

            setValue('patient_id', data.patient_id || data.id);
            setValue('name', data.name);
            setValue('surname', data.surname);
            setValue('cedula', data.cedula);
            setValue('email', data.email);
            setValue('phone_number', data.phone_number);
            setValue('education_level', data.education_level);
            setValue('purchasing_power', data.purchasing_power);
            setValue('dob', data.dob, true); 
            setValue('sex', data.sex);
            setValue('height_cm', data.height_cm);
            
            tagifyFieldNames.forEach(fieldName => {
                let tagValues = data[fieldName]; 
                if (typeof tagValues === 'string' && tagValues.trim() !== '') {
                    tagValues = tagValues.split(',').map(s => s.trim()).filter(s => s);
                } else if (!Array.isArray(tagValues)) {
                    tagValues = [];
                }
                populateTagifyFieldWhenReady(fieldName, tagValues);
            });

            if (isFullEvaluationLoad) {
                setValue('loaded_evaluation_id', data.evaluation_id);
                if(loadedEvaluationIdDisplay && data.evaluation_id) { loadedEvaluationIdDisplay.textContent = `Cargando datos desde Evaluación ID: ${data.evaluation_id} como base para una NUEVA evaluación.`; }
                
                setValue('weight_at_plan', data.weight_at_eval || data.weight_at_plan);
                setValue('wrist_circumference_cm', data.wrist_circumference_cm);
                setValue('waist_circumference_cm', data.waist_circumference_cm);
                setValue('hip_circumference_cm', data.hip_circumference_cm);
                setValue('gestational_age_weeks', data.gestational_age_weeks !== null ? data.gestational_age_weeks : '0');
                setValue('activity_factor', data.activity_factor || '1.2');
                
                const pathologiesFromServer = data.pathologies || [];
                document.querySelectorAll('input[name="pathologies"]').forEach(checkbox => {
                    checkbox.checked = pathologiesFromServer.includes(checkbox.value);
                });
                setValue('other_pathologies_text', data.other_pathologies_text);
                setValue('postoperative_text', data.postoperative_text);
                setValue('diet_type', data.diet_type);
                setValue('other_diet_type_text', data.other_diet_type_text);
                setValue('target_weight', data.target_weight);
                setValue('target_waist_cm', data.target_waist_cm);
                setValue('target_protein_perc', data.target_protein_perc);
                setValue('target_carb_perc', data.target_carb_perc);
                setValue('target_fat_perc', data.target_fat_perc);
                
                const micronutrients = data.micronutrients || {}; 
                setValue('mic_k', micronutrients.potassium_mg);
                setValue('mic_ca', micronutrients.calcium_mg);
                setValue('mic_na', micronutrients.sodium_mg);
                setValue('mic_chol', micronutrients.cholesterol_mg);

                if (planTextArea) {
                    planTextArea.value = data.edited_plan_text || "";
                    if (data.edited_plan_text) {
                        currentFullPlanText = data.edited_plan_text; 
                        displayPlanWithFavoriteButtons(currentFullPlanText); 
                    }
                }
                setValue('user_observations', data.user_observations);
                
                if (typeof currentPlanDataBaseData !== 'undefined') {
                     currentPlanDataBaseData = data; 
                     console.log("Populate (Full Load): currentPlanDataBaseData set:", JSON.stringify(currentPlanDataBaseData, null, 2).substring(0, 200) + "...");
                }
                if(document.getElementById('plan-display-section')) { document.getElementById('plan-display-section').style.display = (data.edited_plan_text ? 'block' : 'none'); }
            } else { 
                 if(loadedEvaluationIdDisplay && data.id) { loadedEvaluationIdDisplay.textContent = `Creando nueva evaluación para Paciente ID: ${data.id}.`; }
                 // Ensure sex is cleared if not loading a full evaluation
                 setValue('sex', '');
                 if (typeof currentPlanDataBaseData !== 'undefined') {
                    currentPlanDataBaseData = null; 
                    console.log("Populate (Patient Only): currentPlanDataBaseData reset to null.");
                 }
                 if(document.getElementById('plan-display-section')) { document.getElementById('plan-display-section').style.display = 'none'; }
            }
            
            console.log("Formulario de Evaluación: Value of sex field after populatePreloadForm:", document.getElementById('sex').value);

            const heightVal = document.getElementById('height_cm').value;
            const weightVal = document.getElementById('weight_at_plan').value;
            const dobVal = document.getElementById('dob').value;
            const sexVal = document.getElementById('sex').value;
            const activityFactorVal = document.getElementById('activity_factor').value;

            if (heightVal && weightVal && dobVal && sexVal && activityFactorVal) {
                if(typeof calcularValores === "function") {
                    console.log("Calling calcularValores() from populatePreloadForm");
                    calcularValores();
                } else {
                    console.warn("calcularValores function not found.");
                }
            } else {
                console.log("Not calling calcularValores from populatePreloadForm, missing data:", {heightVal, weightVal, dobVal, sexVal, activityFactorVal});
            }
        }

        if (formActionInput) {
            formActionInput.value = currentAction;
            console.log("Form action set to:", formActionInput.value);
        }
        
        clearPreloadForm(true); 

        if (currentAction === 'edit_evaluation' && serverContextEvaluationData) {
            console.log("Formulario de Evaluación: Modo EDICIÓN con datos del servidor.");
            isEditMode = true;
            populatePreloadForm(serverContextEvaluationData, true); 
            if(loadedEvaluationIdDisplay && serverContextEvaluationData.evaluation_id) {
                loadedEvaluationIdDisplay.textContent = `Editando Evaluación ID: ${serverContextEvaluationData.evaluation_id}.`;
            }
            if (saveButton) { saveButton.innerHTML = '<i class="fas fa-save"></i> Guardar Cambios en Evaluación'; }
        } else if (currentAction === 'new_eval_for_patient' && patientIdToLoadFromUrl) {
            console.log("Formulario de Evaluación: Acción new_eval_for_patient. Patient ID:", patientIdToLoadFromUrl);
            fetch(`/get_patient_details/${patientIdToLoadFromUrl}`)
                .then(response => {
                    if (!response.ok) { throw new Error(`HTTP error! status: ${response.status}, message: ${response.statusText}`); }
                    return response.json();
                })
                .then(data => {
                    console.log("Datos del paciente recibidos para new_eval_for_patient:", data);
                    populatePreloadForm(data, false); 
                    if(loadedEvaluationIdDisplay) { loadedEvaluationIdDisplay.textContent = `Creando nueva evaluación para Paciente ID: ${patientIdToLoadFromUrl}.`; }
                })
                .catch(error => console.error('Error al cargar datos del paciente para new_eval_for_patient:', error));
        } else if (currentAction === 'load_eval_for_new' && evaluationIdToLoadFromUrl) {
            console.log("Formulario de Evaluación: Acción load_eval_for_new. Evaluation ID:", evaluationIdToLoadFromUrl);
            fetch(`/get_evaluation_data/${evaluationIdToLoadFromUrl}`)
                .then(response => {
                    if (!response.ok) { throw new Error(`HTTP error! status: ${response.status}, message: ${response.statusText}`); }
                    return response.json();
                })
                .then(data => {
                    console.log("Datos de evaluación recibidos para load_eval_for_new:", data);
                    populatePreloadForm(data, true); 
                    if(loadedEvaluationIdDisplay && data.evaluation_id) { loadedEvaluationIdDisplay.textContent = `Cargando datos desde Evaluación ID: ${data.evaluation_id} como base para una NUEVA evaluación.`; }
                })
                .catch(error => console.error('Error al cargar datos de la evaluación para load_eval_for_new:', error));
        } else { 
            console.log("Formulario de Evaluación: Modo NUEVO PACIENTE / NUEVA EVALUACIÓN (default).");
            if(loadedEvaluationIdDisplay) { loadedEvaluationIdDisplay.textContent = 'Creando nueva evaluación para un nuevo paciente.'; }
        }

        if (actionFromUrl || patientIdToLoadFromUrl || evaluationIdToLoadFromUrl) {
            if (!(currentAction === 'edit_evaluation' && serverContextAction === 'edit_evaluation')) {
                history.replaceState(null, '', window.location.pathname);
            }
        }

        if (planTextArea) {
            planTextArea.addEventListener('input', function() {
                if (this.value !== currentFullPlanText) {
                    displayPlanWithFavoriteButtons(this.value);
                }
            });
        }

        // --- SECCIÓN COMENTADA PARA DIAGNÓSTICO ---
        /*
        // La visibilidad del botón sendEmailToPatientButton ahora dependerá de que
        // main.js (función finalizar) lo haga visible después de guardar la evaluación
        // y establecer window.lastSavedEvaluationId.
        // Si se necesita una lógica más robusta aquí (como el MutationObserver),
        // se puede reintroducir con cuidado, asegurándose de que no cause errores de sintaxis.

    }); // Fin DOMContentLoaded
    */ // Fin del comentario de la sección

    }); // Fin DOMContentLoaded

    function escapeHtml(text) {
        if (text === null || text === undefined) { return ""; }
        const map = {
            '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#039;'
        };
        return String(text).replace(/[&<>"']/g, function(m) { return map[m]; }); 
    }

    function displayPlanWithFavoriteButtons(planText) {
        const planDisplayDiv = document.getElementById('plan-display-con-favoritos');
        if (!planDisplayDiv) {
            console.error("Elemento 'plan-display-con-favoritos' no encontrado.");
            return;
        }
        // currentFullPlanText is a global-like variable within the outer DOMContentLoaded scope
        currentFullPlanText = planText || ""; 
        if (!planText) {
            planDisplayDiv.innerHTML = "<p class='text-center p-3 text-muted'>No hay plan para mostrar o está vacío.</p>";
            return;
        }
        let processedHtml = "";
        const lines = planText.split('\n');
        lines.forEach(line => {
            const trimmedLine = line.trim();
            const matchResult = trimmedLine.match(/^Receta N°\d+:\s*(.*)$/i); 
            if (matchResult && matchResult[1]) {
                const recipeName = matchResult[1].trim(); 
                processedHtml += `<div class="d-flex justify-content-between align-items-center py-1 border-bottom">
                                    <strong class="me-2">${escapeHtml(line)}</strong>
                                    <button class="btn btn-sm btn-outline-warning favorite-recipe-btn flex-shrink-0" data-recipe-name="${escapeHtml(recipeName)}">
                                        <i class="fas fa-star"></i> Favorita
                                    </button>
                                  </div>`;
            } else {
                processedHtml += `<p class="mb-1">${escapeHtml(line)}</p>`;
            }
        });
        planDisplayDiv.innerHTML = processedHtml || "<p class='text-center p-3 text-muted'>Plan procesado. No se detectaron recetas con el formato esperado para añadir botones.</p>";
        document.querySelectorAll('.favorite-recipe-btn').forEach(button => {
            button.removeEventListener('click', handleFavoriteRecipeClick); 
            button.addEventListener('click', handleFavoriteRecipeClick);
        });
    }

    async function handleFavoriteRecipeClick(event) {
        const button = event.target.closest('button'); 
        if (!button) { return; }
        const recipeName = button.dataset.recipeName;
        // currentFullPlanText is a global-like variable within the outer DOMContentLoaded scope
        if (!recipeName || !currentFullPlanText) { 
            alert("Error: No se pudo obtener la información de la receta o el plan completo. Asegúrate de que el plan se haya generado.");
            return;
        }
        button.disabled = true;
        button.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Guardando...';
        try {
            const response = await fetch('/api/favorite_generated_preparation', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ recipe_name: recipeName, full_plan_text: currentFullPlanText }),
            });
            const result = await response.json();
            if (response.ok) {
                alert(`"${recipeName}" guardada como preparación favorita (ID: ${result.id}).`);
                button.innerHTML = '<i class="fas fa-check"></i> Guardada';
                button.classList.remove('btn-outline-warning');
                button.classList.add('btn-success');
            } else {
                alert(`Error al guardar: ${result.error || 'No se pudo guardar la preparación como favorita.'}`);
                button.innerHTML = '<i class="fas fa-star"></i> Favorita'; 
                button.disabled = false;
            }
        } catch (error) {
            console.error('Error de red o del cliente al guardar preparación favorita:', error);
            alert('Error de red al intentar guardar la preparación como favorita.');
            button.innerHTML = '<i class="fas fa-star"></i> Favorita'; 
            button.disabled = false;
        }
    }

    window.verPdfTecnico = function() {
        let evaluationId = null;
        if (window.lastSavedEvaluationId) {
            evaluationId = window.lastSavedEvaluationId;
        } else {
            const loadedEvalIdInput = document.getElementById('loaded_evaluation_id');
            if (loadedEvalIdInput && loadedEvalIdInput.value) {
                 evaluationId = loadedEvalIdInput.value;
            }
        }
        if (evaluationId) {
            window.open(`/ver_pdf/${evaluationId}`, '_blank');
        } else {
            alert("No hay una evaluación guardada o cargada para generar el PDF técnico.");
        }
    }
    
    window.verPdfPaciente = function() {
        const evaluationId = window.lastSavedEvaluationId; 
        if (evaluationId) {
            window.open(`/ver_pdf_paciente/${evaluationId}`, '_blank');
        } else {
            alert("No hay una evaluación guardada recientemente para generar el PDF del paciente.");
        }
    }

</script>
{% endblock %}
